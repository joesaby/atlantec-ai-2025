---
import Layout from '../components/common/Layout.astro';
import { getCurrentWeather } from '../utils/weather-client.js';
import WeatherForecast from '../components/weather/WeatherForecast.jsx';

// Irish counties for location selection
const counties = [
  'Carlow', 'Cavan', 'Clare', 'Cork', 'Donegal', 'Dublin', 'Galway', 'Kerry',
  'Kildare', 'Kilkenny', 'Laois', 'Leitrim', 'Limerick', 'Longford', 'Louth',
  'Mayo', 'Meath', 'Monaghan', 'Offaly', 'Roscommon', 'Sligo', 'Tipperary',
  'Waterford', 'Westmeath', 'Wexford', 'Wicklow'
];

// Get the selected county from query params or default to Dublin
const selectedCounty = Astro.url.searchParams.get('county') || 'Dublin';

// Get weather data for the selected county
let weatherData;
try {
  weatherData = await getCurrentWeather(selectedCounty);
} catch (error) {
  console.error('Error fetching weather data:', error);
  // Provide fallback weather data
  weatherData = {
    location: selectedCounty,
    date: new Date(),
    temperature: 12,
    rainfall: 2.5,
    windSpeed: 15,
    windDirection: 'SW',
    humidity: 75,
    weatherDescription: 'Partly Cloudy',
    forecast: JSON.stringify([
      { date: new Date(), temperature: { min: 10, max: 14 }, rainfall: 1.2, description: 'Light Rain' },
      { date: new Date(Date.now() + 86400000), temperature: { min: 11, max: 15 }, rainfall: 0.5, description: 'Partly Cloudy' },
      { date: new Date(Date.now() + 172800000), temperature: { min: 9, max: 13 }, rainfall: 2.1, description: 'Moderate Rain' },
      { date: new Date(Date.now() + 259200000), temperature: { min: 8, max: 12 }, rainfall: 0.8, description: 'Light Rain' },
      { date: new Date(Date.now() + 345600000), temperature: { min: 9, max: 14 }, rainfall: 0.3, description: 'Partly Cloudy' },
    ]),
    created_at: new Date()
  };
}

// Determine garden tasks based on weather
const getGardenTasks = (weather) => {
  const tasks = [];
  
  if (weather.rainfall > 5) {
    tasks.push('Check drainage in your garden beds to prevent waterlogging.');
    tasks.push('Postpone any planting or transplanting until soil dries out a bit.');
    tasks.push('Great day for indoor seedling preparation and planning.');
  } else if (weather.rainfall > 0) {
    tasks.push('Light rain is perfect for transplanting seedlings.');
    tasks.push('Check rain barrels to ensure they are collecting water efficiently.');
    tasks.push('Apply organic mulch to retain moisture in garden beds.');
  } else {
    tasks.push('Water plants early morning or evening to reduce evaporation.');
    tasks.push('Consider setting up shade cloth for sensitive plants.');
    tasks.push('Good day for weeding as roots come out easily from dry soil.');
  }
  
  if (weather.temperature < 5) {
    tasks.push('Protect tender plants from frost with covers or cloches.');
    tasks.push('Hold off on planting warm-season crops.');
    tasks.push('Check heated propagators for early seedlings.');
  } else if (weather.temperature > 18) {
    tasks.push('Ensure plants have adequate water, especially containers.');
    tasks.push('Ventilate greenhouses to prevent overheating.');
    tasks.push('Consider planting heat-loving crops like tomatoes and courgettes.');
  }
  
  if (weather.windSpeed > 20) {
    tasks.push('Secure any loose structures like polytunnels or cloches.');
    tasks.push('Postpone applying any sprays or fertilizers.');
    tasks.push('Check support stakes for tall plants and trees.');
  }
  
  return tasks.slice(0, 5); // Return top 5 most relevant tasks
};

const gardenTasks = getGardenTasks(weatherData);

// Get weather impacts for different plant types
const getPlantImpacts = (weather) => {
  return {
    vegetables: weather.temperature > 15 && weather.rainfall < 5 
      ? 'Favorable conditions for most vegetables. Ensure adequate water for leafy greens.'
      : weather.rainfall > 10 
        ? 'Heavy rain may cause issues for root vegetables. Check for proper drainage.'
        : 'Moderate conditions for most vegetables. Good time for general maintenance.',
    
    fruits: weather.temperature < 5
      ? 'Protect fruit trees and bushes from frost damage.'
      : weather.temperature > 18 
        ? 'Good growing conditions for fruit development. Watch for pests in warm weather.'
        : 'Regular fruit tree maintenance recommended under current conditions.',
    
    herbs: weather.windSpeed > 15
      ? 'Strong winds can damage delicate herbs. Consider temporary protection.'
      : weather.humidity > 80
        ? 'High humidity may encourage fungal issues in some herbs like basil.'
        : 'Current conditions are suitable for most herb varieties.',
    
    flowers: weather.rainfall > 8
      ? 'Heavy rain may damage delicate flowers. Consider protection for prized blooms.'
      : weather.temperature < 8
        ? 'Cool temperatures may slow flower development. Protect tender varieties.'
        : 'Good conditions for flower growth and development.'
  };
};

const plantImpacts = getPlantImpacts(weatherData);
---

<Layout title="Weather">
  <div class="max-w-7xl mx-auto">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Irish Garden Weather</h1>
      <p class="mt-2 text-lg text-gray-600">
        Tailored weather forecasts and advice for gardeners in Ireland.
      </p>
    </header>
    
    <!-- County Selection Form -->
    <div class="bg-white p-4 rounded-lg shadow-md mb-8">
      <form class="flex flex-wrap gap-4 items-end">
        <div class="grow">
          <label for="county" class="block text-sm font-medium text-gray-700 mb-1">
            Select Your County
          </label>
          <select
            id="county"
            name="county"
            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"
          >
            {counties.map(county => (
              <option value={county} selected={county === selectedCounty}>
                {county}
              </option>
            ))}
          </select>
        </div>
        <button
          type="submit"
          class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
        >
          Update Location
        </button>
      </form>
    </div>
    
    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Weather Forecast -->
      <div class="lg:col-span-2">
        <WeatherForecast weatherData={weatherData} client:load />
      </div>
      
      <!-- Gardening Tasks Based on Weather -->
      <div class="bg-green-50 rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Today's Gardening Tasks</h2>
        <p class="text-sm text-gray-700 mb-4">
          Based on the current weather in {selectedCounty}, here are some recommended gardening tasks:
        </p>
        
        <ul class="space-y-3 mb-6">
          {gardenTasks.map(task => (
            <li class="flex items-start">
              <svg class="h-5 w-5 text-green-600 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              <span>{task}</span>
            </li>
          ))}
        </ul>
      </div>
    </div>
    
    <!-- Weather Impact on Plants -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-8">
      <h2 class="text-xl font-semibold mb-6">Weather Impact on Plants</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-amber-50 p-4 rounded-md">
          <h3 class="font-medium text-amber-800 mb-2 flex items-center">
            <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
            </svg>
            Vegetables
          </h3>
          <p class="text-sm text-gray-700">{plantImpacts.vegetables}</p>
        </div>
        
        <div class="bg-red-50 p-4 rounded-md">
          <h3 class="font-medium text-red-800 mb-2 flex items-center">
            <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z"></path>
            </svg>
            Fruits
          </h3>
          <p class="text-sm text-gray-700">{plantImpacts.fruits}</p>
        </div>
        
        <div class="bg-green-50 p-4 rounded-md">
          <h3 class="font-medium text-green-800 mb-2 flex items-center">
            <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
            </svg>
            Herbs
          </h3>
          <p class="text-sm text-gray-700">{plantImpacts.herbs}</p>
        </div>
        
        <div class="bg-purple-50 p-4 rounded-md">
          <h3 class="font-medium text-purple-800 mb-2 flex items-center">
            <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
            Flowers
          </h3>
          <p class="text-sm text-gray-700">{plantImpacts.flowers}</p>
        </div>
      </div>
    </div>
    
    <!-- Historical Weather Patterns -->
    <div class="bg-blue-50 rounded-lg shadow-md p-6 mt-8">
      <h2 class="text-xl font-semibold mb-4">Irish Weather Patterns for Gardeners</h2>
      
      <div class="space-y-6">
        <div>
          <h3 class="font-medium text-blue-800 mb-2">Regional Variations</h3>
          <p class="text-gray-700">
            Ireland's climate varies significantly by region. Western counties like Galway and Kerry experience more rainfall,
            while eastern counties like Dublin and Wexford tend to be drier. The south typically enjoys warmer temperatures,
            while the north can be cooler. Consider these regional differences when selecting plants for your garden.
          </p>
        </div>
        
        <div>
          <h3 class="font-medium text-blue-800 mb-2">Seasonal Patterns</h3>
          <p class="text-gray-700">
            Spring (March-May): Gradually warming with occasional frost, perfect for planting.<br>
            Summer (June-August): Mild temperatures rarely exceeding 25Â°C, good growing conditions.<br>
            Autumn (September-November): Cooling temperatures and increasing rainfall.<br>
            Winter (December-February): Mild winters with occasional frost, rarely severe.
          </p>
        </div>
        
        <div>
          <h3 class="font-medium text-blue-800 mb-2">Weather Challenges for Irish Gardens</h3>
          <p class="text-gray-700">
            Wind exposure is a significant challenge, especially in coastal areas. Consider windbreaks and sheltered planting
            areas. Heavy rainfall can lead to waterlogging, so ensure good drainage in your garden beds. While severe frost is
            rare, occasional cold snaps can damage tender plants, particularly in inland areas away from the moderating influence
            of the Atlantic Ocean.
          </p>
        </div>
      </div>
    </div>
  </div>
</Layout>